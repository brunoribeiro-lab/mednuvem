let pageAjax = 'lancamentos/AJAX-slaughter/';

function message(msg, type, title) {
    let icon = 'error';
    if (type === 'success') {
        icon = 'success';
    }
    Swal.fire({
        title: title,
        html: msg,
        icon: icon,
        timer: type === 'success' ? 2000 : 6000,
        confirmButtonText: 'Fechar',
        showCancelButton: false,
        confirmButtonColor: "#5156be",
        cancelButtonColor: "#fd625e"
    }).then((result) => {
        /* Read more about handling dismissals below */
        if (result.dismiss === Swal.DismissReason.timer) {
            console.log('I was closed by the timer')
        }
    });
}
var backToListing = function () {
    $("#backTo").click(function () {
        $("#box-ajax").addClass('hidden');
        $("#box-listing").removeClass('hidden');
    });
}
// function to validate form
var validateForm = function (form, file) {
    $(form).validate({
        errorElement: 'span',
        errorClass: 'error',
        focusInvalid: true,
        ignore: ":hidden",
        rules: {},
        errorPlacement: function (error, element) {
            var icon = $(element).parent('.input-with-icon').children('i');
            var parent = $(element).parent('.input-with-icon');
            icon.removeClass('fa fa-check').addClass('fa fa-exclamation');
            parent.removeClass('success-control').addClass('error-control');
        },
        highlight: function (element) {
            var parent = $(element).parent();
            parent.removeClass('success-control').addClass('error-control');
        },
        success: function (label, element) {
            var icon = $(element).parent('.input-with-icon').children('i');
            var parent = $(element).parent('.input-with-icon');
            icon.removeClass("fa fa-exclamation").addClass('fa fa-check');
            parent.removeClass('error-control').addClass('success-control');
        },
        invalidHandler: function () {
            $(form + ' button[type=submit], input[type=submit]').attr('disabled', false);
        },
        submitHandler: function (event) {
            Swal.fire({
                title: 'Confirme os dados',
                text: "Antes de continuar confira os dados digitadas",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Continuar',
                cancelButtonText: 'Fechar'
            }).then((result) => {
                if (result.isConfirmed) {
                    if (!$(form).data('beenSubmitted')) {
                        let button = '<i class="fa fa-plus"></i> Cadastrar';
                        if (form == "#formModalUpdate") {
                            button = '<i class="fa fa-sync"></i> Salvar';
                        }
                        $(form + ' button[type=submit], input[type=submit]').removeClass("btn-success").addClass('btn-dark waves-effect waves-light');
                        $(form + ' button[type=submit], input[type=submit]').html('<i class="bx bx-hourglass bx-spin font-size-16 align-middle me-2"></i> Carregando');
                        $(form + " #loading").removeClass('hidden');
                        $(form).data('beenSubmitted', true);
                        var data = new FormData($(form)[0]);
                        $.ajax({
                            url:  file,
                            type: "POST",
                            data: data,
                            processData: false,
                            contentType: false,
                            dataType: "json",
                            success: function (data) {
                                $(form + ' button[type=submit], input[type=submit]').attr('disabled', false);
                                $(form + ' button[type=submit], input[type=submit]').removeClass('btn-dark waves-effect waves-light').addClass('btn-success');
                                $(form + ' button[type=submit], input[type=submit]').html(button);
                                $(form).data('beenSubmitted', false);
                                if (data.error) {
                                    message(data.msg, 'danger');
                                } else {
                                    if(form == "#formModalAddNewLaughterScale")
                                        loadNextBoardingStops()
                                    $("#box-ajax").addClass('hidden');
                                    $("#box-listing").removeClass('hidden');
                                    message(data.msg, 'success');
                                }
                            },
                            error: function (data) {
                                message(data.responseText, 'danger');
                                $(form + ' button[type=submit], input[type=submit]').attr('disabled', false);
                                $(form + ' button[type=submit], input[type=submit]').removeClass('btn-dark waves-effect waves-light').addClass('btn-success');
                                $(form + ' button[type=submit], input[type=submit]').html(button);
                                $(form).data('beenSubmitted', false);
                            },
                            beforeSend: function () {
                            },
                            complete: function () {
                                $(form + ' button[type=submit], input[type=submit]').attr('disabled', false);
                                $(form + ' button[type=submit], input[type=submit]').removeClass('btn-dark waves-effect waves-light').addClass('btn-success');
                                $(form + ' button[type=submit], input[type=submit]').html(button);
                                $(form).data('beenSubmitted', false);
                                $(form + " #loading").addClass('hidden');
                            }
                        });
                        return false;
                    }
                }
            })
        }
    });
};
// function to load modal content and load fields
var loadModalContent = function (updateURL, getURL, form, id) {
    id = typeof id !== 'undefined' ? id : false;
    $("#box-ajax").removeClass('hidden');
    $("#box-listing").addClass('hidden');
    $('#box-ajax').html('<div class="col-md-12 text-center"><p>Carregando...</p><div class="spinner-border text-primary m-1" role="status"><span class="sr-only">Carregando...</span></div></div>');
    var $param = {};
    if (id > 0) {
        $param = { "id": id };
    }
    $(form).data('beenSubmitted', false);
    $(form + ' button[type=submit], input[type=submit]').attr('disabled', false);
    $.post(getURL, $param, function (html) {
        $("#box-ajax").html(html);
        backToListing();
        validateForm(form, updateURL);
    });
};
function real_float(number) {
    return parseFloat(number.replace("R$", "").replace(".", "").replace(",", "."));
}
function number_format(number, decimals, dec_point, thousands_point) {
    if (number == null || !isFinite(number)) {
        throw new TypeError("number is not valid");
    }
    if (!decimals) {
        var len = number.toString().split('.').length;
        decimals = len > 1 ? len : 0;
    }
    if (!dec_point) {
        dec_point = '.';
    }
    if (!thousands_point) {
        thousands_point = ',';
    }
    number = parseFloat(number).toFixed(decimals);
    number = number.replace(".", dec_point);
    var splitNum = number.split(dec_point);
    splitNum[0] = splitNum[0].replace(/\B(?=(\d{3})+(?!\d))/g, thousands_point);
    number = splitNum.join(dec_point);
    return number;
}
function loadNextBoardingStops() {
    $('#content-next-boarding-stops').html('<div class="col-md-12 text-center margin-top-80"><p>Carregando...</p><div class="spinner-border text-primary m-1" role="status"><span class="sr-only">Carregando...</span></div></div>');
    $.post("index/AJAX/next-boarding-stops", function ($html) {
        $("#content-next-boarding-stops").html($html);
    });
}
$(document).ready(function () {
    // Botão Escala de Embarque
    $("#btn-slaughter-scale").click(function () {
        loadModalContent("lancamentos/AJAX-boarding-stops/insert", "lancamentos/AJAX-boarding-stops/get-add", "#formModalAddNewLaughterScale", true);
    });
    // Botão Embarque/Negociado
    $("#btn-boarding-negotiated").click(function () {
        loadModalContent("lancamentos/AJAX-boarding-negotiated/insert", "lancamentos/AJAX-boarding-negotiated/get-add", "#formModalAddNewBoardingNegotiated", true);
    });
    // Botão Abates
    $("#btn-slaughter").click(function () {
        loadModalContent("lancamentos/AJAX-slaughter/insert", "lancamentos/AJAX-slaughter/get-add", "#formModalAddNewLaughter", true);
    });
    // Botão Pedidos
    $("#btn-order").click(function () {
        loadModalContent("lancamentos/AJAX-order/insert", "lancamentos/AJAX-order/get-add", "#formModalAddOrder", true);
    });
    // Botão Romaneios de Expedição
    $("#btn-shipping-packing-list").click(function () {
        pageAjax = 'lancamentos/AJAX-shipping-packing-list/';
        loadModalContent("lancamentos/AJAX-shipping-packing-list/insert", "lancamentos/AJAX-shipping-packing-list/get-add", "#formModalAddNewShippingPackingList", true);
    });

    $("#refresh-next-boarding-stops").click(function () {
        loadNextBoardingStops();
    });
});